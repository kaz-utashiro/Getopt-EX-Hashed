.DELETE_ON_ERROR:

LANGS    := JA KO ZH
RM_LANGS ?= $(LANGS)
ENGINES  ?= gpt5
XLANGS   :=
XENGINES :=

GET_README  := perl -MTOML -0777E 'say from_toml(<>)->{readme_from}'
README_FROM := $(shell $(GET_README) ../minil.toml)
ifneq ($(README_FROM),)
  MOD_PATH := ../$(README_FROM)
  MOD_NAME := $(notdir $(MOD_PATH))
  ORIGIN   := $(MOD_PATH)
  POD      := $(MOD_NAME).pod
else
  MOD_NAME := $(shell perl -MJSON -0777E 'say decode_json(<>)->{name}' ../META.json)
  MOD_PATH := ../lib/$(subst -,/,$(MOD_NAME)).pm
  MOD_FILE := $(notdir $(MOD_PATH))
  MOD_DIR  := $(dir $(MOD_PATH))
  MOD_NAME := $(MOD_FILE:.pm=)
  ORIGIN   := $(MOD_PATH)
  PM       := $(notdir $(ORIGIN))
  POD      := $(PM:.pm=.pod)
endif

LANGPART = $(if $(XENGINES),$(engin)-$(lang),$(lang))

SRC_DIR  :=
SRC      := $(POD:%=$(if $(SRC_DIR),$(SRC_DIR)/,)%)
NAMES    := $(POD:%=$(notdir %))
PODS     := $(foreach engin,$(ENGINES),$(foreach lang,$(LANGS),$(SRC:.pod=.$(LANGPART).pod)))
MDS      := $(foreach engin,$(ENGINES),$(foreach lang,$(LANGS),$(NAMES:.pod=.$(LANGPART).md)))
READMES  := $(foreach engin,$(ENGINES),$(foreach lang,$(LANGS),../README.$(LANGPART).md))
###########
# Translate only JA by gpt-4
#----------
ifneq ($(XENGINES),)
PODS     += $(foreach engin,$(XENGINES),$(foreach lang,$(XLANGS),$(SRC:.pod=.$(LANGPART).pod)))
MDS      += $(foreach engin,$(XENGINES),$(foreach lang,$(XLANGS),$(NAMES:.pod=.$(LANGPART).md)))
READMES  := $(foreach engin,$(XENGINES),$(foreach lang,$(LANGS),../README.$(LANGPART).md))
endif
###########
ALL      := $(PODS) $(MDS) README.md $(READMES)

all: $(ALL)

ifdef SRC_DIR
  $(SRC_DIR):
	mkdir -p $(SRC_DIR)
endif
SRCPATH := $(if $(SRC_DIR),$(SRC_DIR)/,)

GREPLE := PERL5LIB=../lib$${PERL5LIB:+:$$PERL5LIB} greple

PODIFY := $(GREPLE) -Mperl --nocolor --le :pod
$(foreach mod,$(ORIGIN),$(eval \
  $(if $(filter .pm,$(suffix $(mod))),\
    $(SRCPATH)$(subst .pm,.pod,$(notdir $(mod))): $(mod) Makefile; $(PODIFY) $$< > $$@,\
    $(SRCPATH)$(notdir $(mod)).pod: $(mod) Makefile; $(PODIFY) $$< > $$@ \
  )\
))

XLATE := xlate
XLATE += $(if $(XLATE_LABOR),,-a)
XLATE += $(if $(XLATE_INIT),-r)

deepl_JA_FORM   ?= desumasu
deepl_JA_DICT   := $(wildcard *.dict)
deepl_JA_FILTER := $(GREPLE) -Mperl -Msubst::desumasu \
	$(if $(findstring $(deepl_JA_FORM).dict,$(deepl_JA_DICT)),--dict $(deepl_JA_FORM).dict) \
	--pod --subst --all --no-color --need=0 \
	--$(deepl_JA_FORM) 

define LANG_POD
  $(SRCPATH)%.$(LANGPART).pod: $(SRCPATH)%.pod Makefile
  ifdef $2_$1_FILTER
	$$(XLATE) -e $2 -t $1 $$< | $$($2_$1_FILTER) > $$@
  else
	$$(XLATE) -e $2 -t $1 $$< > $$@
  endif
endef

ENGINES+=$(XENGINES)
$(foreach engin,$(ENGINES),$(foreach lang,$(LANGS),$(eval $(call LANG_POD,$(lang),$(engin)))))

%.md: $(SRCPATH)%.pod
	pod2markdown $< > $@

define LANG_README
  ../README.$(LANGPART).md: $(MOD_NAME).$(LANGPART).md
	cp $$< $$@
endef

$(foreach engin,$(ENGINES),$(foreach lang,$(RM_LANGS),$(eval $(call LANG_README,$(lang),$(engin)))))

README.md: Makefile
	exec > $@ && \
	printf '## Languages\n\n' && \
	for md in $(MDS) ; \
	do \
	    echo "- [$$md]($$md)" ; \
	done

clean:
	rm -f $(SRC) $(ALL)
